<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bupt.goodservice.mapper.StatsMapper">

    <resultMap id="MonthlyStatsResultMap" type="bupt.goodservice.dto.MonthlyStats">
        <!-- 
            为 MonthlyStats 对象定义一个复合主键。
            根据 GROUP BY 子句，(月份 + 服务类型 + 地域ID) 构成了一个唯一的结果行。
            这会告诉 MyBatis 将每一行都映射为一个独立的 MonthlyStats 对象，而不是根据 region_id 进行合并。
        -->
        <id property="month" column="month"/>
        <id property="serviceType" column="service_type"/>
        <id property="region.id" column="region_id"/>

        <!-- 'column' 属性必须与 SQL 查询中的别名完全匹配 -->
        <result property="requestCount" column="total_requests" jdbcType="BIGINT"/>
        <result property="successCount" column="successful_requests" jdbcType="BIGINT"/>

        <!-- 嵌套的 RegionalDivisions 对象映射 -->
        <association property="region" javaType="bupt.goodservice.model.RegionalDivisions">
            <id property="id" column="region_id" jdbcType="INTEGER"/>
            <result property="regionalCode" column="regional_code" jdbcType="VARCHAR"/>
            <result property="regionalName" column="regional_name" jdbcType="VARCHAR"/>
            <result property="cityName" column="city_name" jdbcType="VARCHAR"/>
            <result property="provinceName" column="province_name" jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <select id="getMonthlyStatsTotal" resultMap="MonthlyStatsResultMap">
        SELECT
        DATE_FORMAT(rq.create_time, '%Y-%m') AS month,
        rd.id as region_id,
        rd.regional_code,
        rd.regional_name,
        rd.city_name,
        rd.province_name,
        rq.service_type,
        COUNT(DISTINCT rq.id) AS total_requests,
        COUNT(DISTINCT CASE WHEN rp.status = 1 THEN rq.id END) AS successful_requests
        FROM
        service_request rq
        LEFT JOIN
        service_response rp ON rq.id = rp.request_id
        JOIN
        regional_divisions rd ON rq.region_id = rd.id
        <where>
            rq.create_time >= #{first}
            AND rq.create_time &lt;= #{last}
            <if test="region != null and region != ''">
                AND (
                rd.city_name LIKE CONCAT('%', #{region}, '%')
                OR rd.province_name LIKE CONCAT('%', #{region}, '%')
                )
            </if>
        </where>
        GROUP BY
        month, rq.service_type, rd.id
        ORDER BY
        month desc
    </select>

</mapper>
