<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bupt.goodservice.mapper.StatsMapper">

    <!-- This is a complex query and highly dependent on the final DB schema. -->
    <!-- This is a simplified example assuming a successful_response table exists. -->
    <select id="getMonthlyStats" resultType="bupt.goodservice.dto.MonthlyStats">
        SELECT
            DATE_FORMAT(sr.create_time, '%Y-%m') AS month,
            r.name AS region,
            sr.service_type AS serviceType,
            COUNT(DISTINCT sr.id) AS requestCount,
            COUNT(DISTINCT suc.request_id) AS successCount
        FROM
            service_request sr
        LEFT JOIN
            successful_response suc ON sr.id = suc.request_id
        JOIN
            region r ON sr.region_id = r.id
        <where>
            <if test="startMonth != null">
                AND sr.create_time >= #{startMonth.atDay(1)}
            </if>
            <if test="endMonth != null">
                AND sr.create_time &lt;= #{endMonth.atEndOfMonth}
            </if>
            <if test="region != null and region != ''">
                AND r.name LIKE CONCAT('%', #{region}, '%')
            </if>
        </where>
        GROUP BY
            month, region, serviceType
        ORDER BY
            <choose>
                <when test="sortBy == 'requestCount'">requestCount</when>
                <when test="sortBy == 'successCount'">successCount</when>
                <otherwise>month, region, serviceType</otherwise>
            </choose>
            <if test="sortOrder != null and (sortOrder == 'asc' or sortOrder == 'desc')">
                ${sortOrder}
            </if>
    </select>

</mapper>
