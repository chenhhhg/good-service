<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bupt.goodservice.mapper.StatsMapper">

    <resultMap id="MonthlyStatsResultMap" type="bupt.goodservice.dto.MonthlyStats">
        <!-- 基本字段映射 - 这些来自聚合查询结果 -->
        <result property="month" column="stat_month" jdbcType="VARCHAR"/>
        <result property="serviceType" column="service_type" jdbcType="VARCHAR"/>
        <result property="requestCount" column="total_requests" jdbcType="BIGINT"/>
        <result property="successCount" column="successful_requests" jdbcType="BIGINT"/>

        <!-- 嵌套的 RegionalDivisions 对象映射 -->
        <association property="region" javaType="bupt.goodservice.model.RegionalDivisions">
            <id property="id" column="region_id" jdbcType="INTEGER"/>
            <result property="regionalCode" column="regional_code" jdbcType="VARCHAR"/>
            <result property="regionalName" column="regional_name" jdbcType="VARCHAR"/>
            <result property="cityName" column="city_name" jdbcType="VARCHAR"/>
            <result property="provinceName" column="province_name" jdbcType="VARCHAR"/>
        </association>
    </resultMap>

    <select id="getMonthlyStatsTotal" resultType="bupt.goodservice.dto.MonthlyStats">
        SELECT
        DATE_FORMAT(rq.create_time, '%Y-%m') AS month,
        rd.id as region_id,
        rd.regional_code,
        rd.regional_name,
        rd.city_name,
        rd.province_name,
        rq.service_type AS serviceType,
        service_type,
        COUNT(DISTINCT rq.id) AS requestCount
        FROM
        service_request rq
        LEFT JOIN
        service_response rp ON rq.id = rp.request_id
        JOIN
        regional_divisions rd ON rq.region_id = rd.id
        <where>
            AND rq.create_time >= #{first}
            AND rq.create_time &lt;= #{last}
            <if test="region != null and region != ''">
                AND (
                rd.city_name LIKE CONCAT('%', #{region}, '%')
                OR rd.province_name LIKE CONCAT('%', #{region}, '%')
                )
            </if>
            <if test="success">
                AND rq.status = 1
            </if>
        </where>
        GROUP BY
        month, serviceType, rd.id
        ORDER BY
        month desc
    </select>

</mapper>
